dist: focal
os: linux
language: cpp
cache: ccache
jobs:
  include:
    - compiler: gcc
      env:
        - COVERAGE=true
        - TEST_ON=ON
        - CXX_FLAGS="-O0 -g --coverage"
      addons:
        apt:
          packages: lcov
    - compiler: gcc
      env:
        - TEST_ON=OFF
    - compiler: gcc
      env:
        - LIB_MODE=ON
    - compiler: clang
      env:
        - TEST_ON=ON
    - compiler: clang
      env:
        - TEST_ON=OFF
    - compiler: clang
      env:
        - LIB_MODE=ON
before_install: |
  mkdir -p $HOME/.ccache
  mkdir -p $HOME/.ccache/CPM
script: |
  cmake -S . -B build -DCMAKE_EXPORT_COMPILE_COMMANDS=ON -DBUILD_WITH_TEST=${TEST_ON} -DCMAKE_CXX_COMPILER_LAUNCHER=ccache -DCPM_SOURCE_CACHE=$HOME/.ccache/CPM -DCMAKE_CXX_FLAGS="$CXX_FLAGS"
  cmake --build build
  ./build/minimalcpppj
after_success: |
  if [ $COVERAGE == true ] ; then bash -x scripts/run-codecov.sh; fi
